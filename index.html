<script>
  const scanList = document.getElementById("scanList");

  let buffer = "";
  let scanned = new Set();

  /* ===============================
     LOCAL STORAGE HELPERS
     =============================== */
  const STORAGE_KEY = "zebra_scans";

  function saveLocally() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify([...scanned]));
  }

  function loadLocally() {
    const data = localStorage.getItem(STORAGE_KEY);
    if (!data) return;

    const arr = JSON.parse(data);
    arr.forEach(code => {
      scanned.add(code);
      appendToList(code);
    });
  }

  function appendToList(code) {
    const li = document.createElement("li");
    li.textContent = code;
    scanList.prepend(li);
  }

  /* ===============================
     SCANNER INPUT (GLOBAL)
     =============================== */
  document.addEventListener("keydown", function (e) {
    if (e.key === "Shift" || e.key === "Alt" || e.key === "Control") return;

    if (e.key === "Enter") {
      const code = buffer.trim();
      buffer = "";

      if (!code) return;

      if (scanned.has(code)) return;

      scanned.add(code);
      appendToList(code);
      saveLocally();
    } else {
      buffer += e.key;
    }
  });

  /* ===============================
     EXIT / NAVIGATION PROTECTION
     =============================== */

  // Back / refresh / close tab
  window.addEventListener("beforeunload", function (e) {
    if (scanned.size === 0) return;

    saveLocally();
    e.preventDefault();
    e.returnValue = ""; // Required for Chrome
  });

  // App background / tab switch
  document.addEventListener("visibilitychange", function () {
    if (document.hidden) {
      saveLocally();
    }
  });

  // Android back button (history trap)
  history.pushState(null, "", location.href);
  window.addEventListener("popstate", function () {
    saveLocally();
    alert("Scans saved locally. Use Export CSV to download.");
    history.pushState(null, "", location.href);
  });

  /* ===============================
     CSV EXPORT (Downloads)
     =============================== */
  function downloadCSV() {
    if (scanned.size === 0) {
      alert("No scans to export");
      return;
    }

    let csv = "Barcode\n";
    scanned.forEach(code => {
      csv += code + "\n";
    });

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "scanned_barcodes.csv";
    a.click();

    URL.revokeObjectURL(url);
  }

  /* ===============================
     RESTORE ON LOAD
     =============================== */
  window.onload = loadLocally;
</script>
